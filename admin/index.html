<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tinyproxy Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 20px;
            padding-bottom: 20px;
            background-color: #f5f5f5;
        }
        .header {
            padding-bottom: 20px;
            border-bottom: 1px solid #e5e5e5;
            margin-bottom: 30px;
        }
        .card {
            margin-bottom: 20px;
        }
        .stats-container {
            margin-top: 30px;
        }
        .refresh-btn {
            margin-bottom: 20px;
        }
        .proxy-status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }
        .status-up {
            background-color: #d4edda;
            color: #155724;
        }
        .status-down {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header clearfix">
            <h3 class="text-muted">Tinyproxy Admin Dashboard</h3>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div id="proxy-status" class="proxy-status">
                    Checking proxy status...
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Proxy Information</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Version:</strong> <span id="proxy-version">Loading...</span></p>
                        <p><strong>Status:</strong> <span id="proxy-status-text">Loading...</span></p>
                        <p><strong>Uptime:</strong> <span id="proxy-uptime">Loading...</span></p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Connection Information</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Total Connections:</strong> <span id="total-connections">Loading...</span></p>
                        <p><strong>Active Connections:</strong> <span id="active-connections">Loading...</span></p>
                        <p><strong>Idle Connections:</strong> <span id="idle-connections">Loading...</span></p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row stats-container">
            <div class="col-md-12">
                <button id="refresh-stats" class="btn btn-primary refresh-btn">Refresh Statistics</button>
                <div class="card">
                    <div class="card-header">
                        <h5>Tinyproxy Statistics</h5>
                    </div>
                    <div class="card-body">
                        <div id="stats-content">
                            Loading statistics...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Configuration</h5>
                    </div>
                    <div class="card-body">
                        <p>To configure your applications to use this proxy:</p>
                        <pre><code>
# Environment variables for your application
HTTP_PROXY=http://your-server-ip:8888
HTTPS_PROXY=http://your-server-ip:8888

# For Node.js applications
const axios = require('axios');
const httpsProxyAgent = require('https-proxy-agent');

const proxyConfig = {
  proxy: {
    host: 'your-server-ip',
    port: 8888
  }
};

// Make requests through the proxy
axios.get('https://api.example.com', proxyConfig)
  .then(response => console.log(response.data));
                        </code></pre>
                    </div>
                </div>
            </div>
        </div>

        <footer class="footer mt-5">
            <p>&copy; 2025 Tinyproxy Admin</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check proxy status
            checkProxyStatus();

            // Get proxy statistics
            getProxyStats();

            // Add refresh button event
            document.getElementById('refresh-stats').addEventListener('click', function() {
                checkProxyStatus();
                getProxyStats();
            });

            // Set up auto-refresh every 30 seconds
            setInterval(function() {
                checkProxyStatus();
                getProxyStats();
            }, 30000);
        });

        function checkProxyStatus() {
            fetch('/api/stats')
                .then(response => {
                    if (response.ok) {
                        updateProxyStatusUp();
                        return response.text();
                    } else {
                        updateProxyStatusDown();
                        throw new Error('Proxy is not responding');
                    }
                })
                .then(html => {
                    // Parse the HTML response to extract statistics
                    parseProxyStatsHtml(html);
                })
                .catch(error => {
                    console.error('Error checking proxy status:', error);
                    updateProxyStatusDown();
                });
        }

        function updateProxyStatusUp() {
            const statusElement = document.getElementById('proxy-status');
            statusElement.className = 'proxy-status status-up';
            statusElement.textContent = 'Proxy is running';

            document.getElementById('proxy-status-text').textContent = 'Running';
        }

        function updateProxyStatusDown() {
            const statusElement = document.getElementById('proxy-status');
            statusElement.className = 'proxy-status status-down';
            statusElement.textContent = 'Proxy is not responding';

            document.getElementById('proxy-status-text').textContent = 'Not responding';
            document.getElementById('proxy-version').textContent = 'Unknown';
            document.getElementById('proxy-uptime').textContent = 'Unknown';
            document.getElementById('total-connections').textContent = 'Unknown';
            document.getElementById('active-connections').textContent = 'Unknown';
            document.getElementById('idle-connections').textContent = 'Unknown';
        }

        function getProxyStats() {
            fetch('/api/stats')
                .then(response => {
                    if (response.ok) {
                        return response.text();
                    } else {
                        throw new Error('Failed to get proxy statistics');
                    }
                })
                .then(html => {
                    document.getElementById('stats-content').innerHTML = html;
                    parseProxyStatsHtml(html);
                })
                .catch(error => {
                    console.error('Error fetching proxy stats:', error);
                    document.getElementById('stats-content').textContent = 'Failed to load statistics';
                });
        }

        function parseProxyStatsHtml(html) {
            // This is a basic parser that assumes the Tinyproxy stats page format
            // It may need to be adjusted based on the actual output format

            // Try to extract version
            const versionMatch = html.match(/Tinyproxy\s+(\d+\.\d+\.\d+)/i);
            if (versionMatch) {
                document.getElementById('proxy-version').textContent = versionMatch[1];
            }

            // Try to extract connection info from the stats HTML
            // These are simplified and may need to be adjusted
            const openConnMatch = html.match(/Open connections:\s*(\d+)/i);
            if (openConnMatch) {
                document.getElementById('active-connections').textContent = openConnMatch[1];
            }

            const reqMatch = html.match(/Number of requests:\s*(\d+)/i);
            if (reqMatch) {
                document.getElementById('total-connections').textContent = reqMatch[1];
            }

            // Calculate idle connections (this is an approximation)
            const active = parseInt(document.getElementById('active-connections').textContent) || 0;
            document.getElementById('idle-connections').textContent = '0';

            // Try to extract uptime
            const uptimeMatch = html.match(/Uptime:\s*(.+?)\s*</i);
            if (uptimeMatch) {
                document.getElementById('proxy-uptime').textContent = uptimeMatch[1];
            }
        }
    </script>
</body>
</html>